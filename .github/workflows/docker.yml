name: Build Docker

on: 
  push:
    branches:
      - 'dev'

jobs:
    build:
        runs-on: ubuntu-latest

        services:
          mariadb:
            image: mariadb:latest
            ports:
              - 4000:3306
            env:
              MYSQL_ROOT_PASSWORD: SuperSecretPassword
              MYSQL_DATABASE: vaulttube
              MYSQL_USER: vaulttube
              MYSQL_PASSWORD: SuperSecretPassword

        steps:
          - name: Checkout Code
            uses: actions/checkout@v3
          - name: Setup PyTest and Deps
            run: |
              sudo apt update && sudo apt install -y libmariadb-dev
              pip install -r requirements.txt
              pip install pytest
          - name: Run Tests
            run: |
              python -m pytest -v tests
          - name: Verify Database
            run: |
              mariadb -u root -pSuperSecretPassword -P 4000 -h 127.0.0.1 vaulttube -e 'show tables;'
          - name: "docker hub login"
            uses: docker/login-action@v1
            with: 
                username: ${{secrets.DOCKER_HUB_USERNAME}}
                password: ${{secrets.DOCKER_HUB_ACCESS_TOKEN}}
          - name: "build and push"
            uses: docker/build-push-action@v2
            with: 
              context: .
              push: true
              tags: dyslexicjedi/vaulttube:dev, dyslexicjedi/vaulttube:${{github.run_number}}