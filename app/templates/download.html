{% extends "base.html" %}
{% block content %}
<div class="container-lg">
    <h3>Download</h3>
    <div class="input-group mb-3">
        <input id="yturl" type="text" class="form-control" placeholder="Youtube URL" aria-label="Youtube URL" aria-describedby="button-addon2">
        <button class="btn btn-outline-secondary" type="button" id="button-addon2" onclick="processdownload();">Download</button>
      </div>
</div>
<hr>
<h4 class="toprow">Download Queue Length: <div id="queuelength"></div></h4>
<div id="downloadProgressBar"></div>
<div id="spinner" class="lds-ring"><div></div><div></div><div></div><div></div></div>
<div id="dlpush" style="height: 200px;"></div>
<script>
    function isNumeric(n) {
        return !isNaN(parseFloat(n)) && isFinite(n);
    }
    function processdownload(){
        $("#spinner").show();
        var yturl = $("#yturl").val();
        if(yturl.includes("watch?v=")){
            id = yturl.split('=')[1]
            $.ajax({url: "/api/download/single/"+id, success: function(result){
                $("#spinner").hide();
            //$("#watchstatus").html("<button class='btn btn-outline-secondary' onclick=\"markUnwatched()\">Watched</button>");
            }});
            
        }
    }
    async function getStatus(){
        let queueSize;
        let downloadProgress;
        try{
            const r = await fetch("/api/status/download/");
            downloadProgress = await r.text();
            const q = await fetch("/api/status/queue/");
            queueSize = await q.text();
            $("#queuelength").text(queueSize);
            if(isNumeric(downloadProgress)){
                $("#downloadProgressBar").empty();
            }
            else{
                var dp = /^.* (\d+).*$/g;
                var idp = dp.exec(downloadProgress);
                $("#downloadProgressBar").empty();
                $("#downloadProgressBar").html("<div class=\"progress\"><div class=\"progress-bar progress-bar-striped\" role=\"progressbar\" style=\"width: "+idp[1]+"%\" aria-valuenow=\"25\" aria-valuemin=\"0\" aria-valuemax=\"100\"></div></div>");
            }
        }
        catch(e){
            console.error("Polling Error",e);
        }
        //Do stuff here
        setTimeout(getStatus,3000);
    }
    getStatus();
</script>
{% endblock %}